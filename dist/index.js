"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const node_fetch_1 = require("node-fetch");
const tough = require("tough-cookie");
const requestInit = {
    cache: 'no-store',
    // Currently node-fetch doesn't support this, it's a problem when page is redirected but cookies set by the page
    // are required. A workaround is setting redirect to 'manual' so that web-walk can catch cookies.
    credentials: 'include',
    mode: 'cors',
    redirect: 'follow',
    headers: {
        'accept': '*/*',
        'accept-encoding': 'gzip,deflate,br',
        'connection': 'close',
        'user-agent': `web-walk/${require('../package.json').version}`,
    }
};
const getCookieHeader = (siteCookies, mandatoryCookies) => {
    let override = Object.keys(mandatoryCookies)
        .map(key => new tough.Cookie({ key, value: mandatoryCookies[key] }).cookieString())
        .join(';');
    return [siteCookies, override].filter(v => !!v).join(';');
};
const getFormData = (formDataPairs) => {
    const keys = Object.keys(formDataPairs);
    if (!keys.length)
        return;
    return keys
        .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(formDataPairs[key]))
        .join('&');
};
const injectCookieHeader = (headers, cookieHeader) => {
    let mergedCookieHeader = [headers['cookie'], cookieHeader]
        .filter(v => !!v)
        .map(v => v.trim())
        .join(';');
    if (!!mergedCookieHeader) {
        headers = Object.assign({}, headers, { 'cookie': mergedCookieHeader });
    }
    return headers;
};
const transformHeaders = (headers) => {
    let pairs = {};
    headers.forEach((value, key) => {
        let lower = key.toLowerCase();
        if ('set-cookie' !== lower) {
            pairs[lower] = value;
        }
    });
    return pairs;
};
const extractCookies = (setCookies) => {
    let pairs = {};
    if (setCookies && setCookies.length) {
        setCookies.forEach(line => {
            let parsed = tough.parse(line);
            Object.assign(pairs, { [parsed.key]: parsed.value });
        });
    }
    return pairs;
};
const mergeHeaders = (...headersArgs) => {
    let flattened = Object.assign.apply(Object, [{}].concat(headersArgs));
    let merged = {};
    Object.keys(flattened).forEach(key => merged[key.toLowerCase()] = flattened[key]);
    return merged;
};
const prepare = (step, stepResponses) => __awaiter(this, void 0, void 0, function* () {
    const lastStepResponse = stepResponses.length ? stepResponses[stepResponses.length - 1] : undefined;
    return step.prepare ? step.prepare(lastStepResponse, stepResponses) : {};
});
const process = (step, stepResponse) => __awaiter(this, void 0, void 0, function* () {
    return step.process ? step.process(stepResponse) : stepResponse.text;
});
/**
 * Generate request
 * @param config
 * @param step
 * @param responses
 */
const getRequest = (config, step, prepared, siteCookies) => {
    if (!step.request) {
        step.request = {};
    }
    let headers = mergeHeaders(requestInit.headers, config.headers, step.request.headers, prepared.headers);
    let cookies = getCookieHeader(siteCookies, Object.assign({}, config.cookies, step.request.cookies, prepared.cookies));
    let formData = getFormData(Object.assign({}, step.request.formData, prepared.formData));
    let request = Object.assign({}, requestInit, step.request, prepared);
    request.headers = injectCookieHeader(headers, cookies);
    if (!request.body && formData) {
        request.body = formData;
        if (!request.headers['content-type']) {
            request.headers['content-type'] = 'application/x-www-form-urlencoded';
        }
    }
    if (!request.method && request.body) {
        request.method = 'POST';
    }
    delete request.cookies;
    delete request.formData;
    return request;
};
exports.walk = (config) => __awaiter(this, void 0, void 0, function* () {
    if (!config || !config.steps)
        return;
    let stepResponses = [];
    let stepResponse;
    let cookieJar = new tough.CookieJar();
    for (let i = 0; i < config.steps.length; ++i) {
        const step = config.steps[i];
        const prepared = yield prepare(step, stepResponses);
        const url = prepared.url || step.url;
        const siteCookies = cookieJar.getCookieStringSync(url);
        const request = getRequest(config, step, prepared, siteCookies);
        const response = yield node_fetch_1.default(url, request);
        const setCookieHeaders = response.headers.raw()['set-cookie'] || [];
        stepResponse = {
            headers: transformHeaders(response.headers),
            cookies: extractCookies(setCookieHeaders),
            text: yield response.text()
        };
        stepResponse.output = yield process(step, stepResponse);
        stepResponses.push(stepResponse);
        setCookieHeaders.forEach(line => cookieJar.setCookieSync(line, response.url));
    }
    return stepResponse.output;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLDJDQUErQjtBQUMvQixzQ0FBc0M7QUFFdEMsTUFBTSxXQUFXLEdBQWdCO0lBQy9CLEtBQUssRUFBRSxVQUFVO0lBQ2pCLGdIQUFnSDtJQUNoSCxpR0FBaUc7SUFDakcsV0FBVyxFQUFFLFNBQVM7SUFDdEIsSUFBSSxFQUFFLE1BQU07SUFDWixRQUFRLEVBQUUsUUFBUTtJQUNsQixPQUFPLEVBQUU7UUFDUCxRQUFRLEVBQUUsS0FBSztRQUNmLGlCQUFpQixFQUFFLGlCQUFpQjtRQUNwQyxZQUFZLEVBQUUsT0FBTztRQUNyQixZQUFZLEVBQUUsWUFBWSxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxPQUFPLEVBQUU7S0FDL0Q7Q0FDRixDQUFBO0FBRUQsTUFBTSxlQUFlLEdBQUcsQ0FBQyxXQUFtQixFQUFFLGdCQUE2QixFQUFVLEVBQUU7SUFDckYsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztTQUN2QyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztTQUNsRixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDZixNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM1RCxDQUFDLENBQUE7QUFFRCxNQUFNLFdBQVcsR0FBRyxDQUFDLGFBQTBCLEVBQVUsRUFBRTtJQUN6RCxNQUFNLElBQUksR0FBRyxN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QUFBO1FBQ0QsWUFBWSxDQUFDLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDeEQsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNqQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNoRixDQUFDO0lBQ0QsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7QUFDN0IsQ0FBQyxDQUFBLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2ggZnJvbSAnbm9kZS1mZXRjaCc7XG5pbXBvcnQgKiBhcyB0b3VnaCBmcm9tICd0b3VnaC1jb29raWUnO1xuXG5jb25zdCByZXF1ZXN0SW5pdDogUmVxdWVzdEluaXQgPSB7XG4gIGNhY2hlOiAnbm8tc3RvcmUnLFxuICAvLyBDdXJyZW50bHkgbm9kZS1mZXRjaCBkb2Vzbid0IHN1cHBvcnQgdGhpcywgaXQncyBhIHByb2JsZW0gd2hlbiBwYWdlIGlzIHJlZGlyZWN0ZWQgYnV0IGNvb2tpZXMgc2V0IGJ5IHRoZSBwYWdlXG4gIC8vIGFyZSByZXF1aXJlZC4gQSB3b3JrYXJvdW5kIGlzIHNldHRpbmcgcmVkaXJlY3QgdG8gJ21hbnVhbCcgc28gdGhhdCB3ZWItd2FsayBjYW4gY2F0Y2ggY29va2llcy5cbiAgY3JlZGVudGlhbHM6ICdpbmNsdWRlJyxcbiAgbW9kZTogJ2NvcnMnLFxuICByZWRpcmVjdDogJ2ZvbGxvdycsXG4gIGhlYWRlcnM6IHtcbiAgICAnYWNjZXB0JzogJyovKicsXG4gICAgJ2FjY2VwdC1lbmNvZGluZyc6ICdnemlwLGRlZmxhdGUsYnInLFxuICAgICdjb25uZWN0aW9uJzogJ2Nsb3NlJyxcbiAgICAndXNlci1hZ2VudCc6IGB3ZWItd2Fsay8ke3JlcXVpcmUoJy4uL3BhY2thZ2UuanNvbicpLnZlcnNpb259YCxcbiAgfVxufVxuXG5jb25zdCBnZXRDb29raWVIZWFkZXIgPSAoc2l0ZUNvb2tpZXM6IHN0cmluZywgbWFuZGF0b3J5Q29va2llczogU3RyaW5nUGFpcnMpOiBzdHJpbmcgPT4ge1xuICBsZXQgb3ZlcnJpZGUgPSBPYmplY3Qua2V5cyhtYW5kYXRvcnlDb29raWVzKVxuICAgICAgLm1hcChrZXkgPT4gbmV3IHRvdWdoLkNvb2tpZSh7IGtleSwgdmFsdWU6IG1hbmRhdG9yeUNvb2tpZXNba2V5XSB9KS5jb29raWVTdHJpbmcoKSlcbiAgICAgIC5qb2luKCc7Jyk7XG4gIHJldHVybiBbc2l0ZUNvb2tpZXMsIG92ZXJyaWRlXS5maWx0ZXIodiA9PiAhIXYpLmpvaW4oJzsnKTtcbn1cblxuY29uc3QgZ2V0Rm9ybURhdGEgPSAoZm9ybURhdGFQYWlyczogU3RyaW5nUGFpcnMpOiBzdHJpbmcgPT4ge1xuICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZm9ybURhdGFQYWlycyk7XG4gIGlmICgha2V5cy5sZW5ndGgpIHJldHVybjtcbiAgcmV0dXJuIGtleXNcbiAgICAgIC5tYXAoa2V5ID0+IGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGZvcm1EYXRhUGFpcnNba2V5XSkpXG4gICAgICAuam9pbignJicpO1xufVxuXG5jb25zdCBpbmplY3RDb29raWVIZWFkZXIgPSAoaGVhZGVyczogU3RyaW5nUGFpcnMsIGNvb2tpZUhlYWRlcjogc3RyaW5nKTogU3RyaW5nUGFpcnMgPT4ge1xuICBsZXQgbWVyZ2VkQ29va2llSGVhZGVyID0gW2hlYWRlcnNbJ2Nvb2tpZSddLCBjb29raWVIZWFkZXJdXG4gICAgICAuZmlsdGVyKHYgPT4gISF2KVxuICAgICAgLm1hcCh2ID0+IHYudHJpbSgpKVxuICAgICAgLmpvaW4oJzsnKTtcbiAgaWYgKCEhbWVyZ2VkQ29va2llSGVhZGVyKSB7XG4gICAgaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIGhlYWRlcnMsIHsgJ2Nvb2tpZSc6IG1lcmdlZENvb2tpZUhlYWRlciB9KTtcbiAgfVxuICByZXR1cm4gaGVhZGVycztcbn1cblxuY29uc3QgdHJhbnNmb3JtSGVhZGVycyA9IChoZWFkZXJzOiBIZWFkZXJzKTogU3RyaW5nUGFpcnMgPT4ge1xuICBsZXQgcGFpcnM6IFN0cmluZ1BhaXJzID0ge307XG4gIGhlYWRlcnMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgIGxldCBsb3dlciA9IGtleS50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICgnc2V0LWNvb2tpZScgIT09IGxvd2VyKSB7XG4gICAgICBwYWlyc1tsb3dlcl0gPSB2YWx1ZTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gcGFpcnM7XG59XG5cbmNvbnN0IGV4dHJhY3RDb29raWVzID0gKHNldENvb2tpZXM6IHN0cmluZ1tdKTogU3RyaW5nUGFpcnMgPT4ge1xuICBsZXQgcGFpcnM6IFN0cmluZ1BhaXJzID0ge307XG4gIGlmIChzZXRDb29raWVzICYmIHNldENvb2tpZXMubGVuZ3RoKSB7XG4gICAgc2V0Q29va2llcy5mb3JFYWNoKGxpbmUgPT4ge1xuICAgICAgbGV0IHBhcnNlZCA9IHRvdWdoLnBhcnNlKGxpbmUpO1xuICAgICAgT2JqZWN0LmFzc2lnbihwYWlycywgeyBbcGFyc2VkLmtleV06IHBhcnNlZC52YWx1ZSB9KTtcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gcGFpcnM7XG59XG5cbmNvbnN0IG1lcmdlSGVhZGVycyA9ICguLi5oZWFkZXJzQXJnczogYW55W10pOiBTdHJpbmdQYWlycyA9PiB7XG4gIGxldCBmbGF0dGVuZWQgPSBPYmplY3QuYXNzaWduLmFwcGx5KE9iamVjdCwgW3t9XS5jb25jYXQoaGVhZGVyc0FyZ3MpKTtcbiAgbGV0IG1lcmdlZDogU3RyaW5nUGFpcnMgPSB7fTtcbiAgT2JqZWN0LmtleXMoZmxhdHRlbmVkKS5mb3JFYWNoKGtleSA9PiBtZXJnZWRba2V5LnRvTG93ZXJDYXNlKCldID0gZmxhdHRlbmVkW2tleV0pO1xuICByZXR1cm4gbWVyZ2VkO1xufVxuXG5jb25zdCBwcmVwYXJlID0gYXN5bmMgKHN0ZXA6IFdlYldhbGtTdGVwQ29uZmlnLCBzdGVwUmVzcG9uc2VzOiBXZWJXYWxrUmVzcG9uc2VbXSk6IFByb21pc2U8V2ViV2Fsa1JlcXVlc3Q+ID0+IHtcbiAgY29uc3QgbGFzdFN0ZXBSZXNwb25zZSA9IHN0ZXBSZXNwb25zZXMubGVuZ3RoID8gc3RlcFJlc3BvbnNlc1tzdGVwUmVzcG9uc2VzLmxlbmd0aCAtIDFdIDogdW5kZWZpbmVkO1xuICByZXR1cm4gc3RlcC5wcmVwYXJlID8gc3RlcC5wcmVwYXJlKGxhc3RTdGVwUmVzcG9uc2UsIHN0ZXBSZXNwb25zZXMpIDoge307XG59XG5cbmNvbnN0IHByb2Nlc3MgPSBhc3luYyAoc3RlcDogV2ViV2Fsa1N0ZXBDb25maWcsIHN0ZXBSZXNwb25zZTogV2ViV2Fsa1Jlc3BvbnNlKTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgcmV0dXJuIHN0ZXAucHJvY2VzcyA/IHN0ZXAucHJvY2VzcyhzdGVwUmVzcG9uc2UpIDogc3RlcFJlc3BvbnNlLnRleHQ7XG59XG5cbi8qKlxuICogR2VuZXJhdGUgcmVxdWVzdFxuICogQHBhcmFtIGNvbmZpZ1xuICogQHBhcmFtIHN0ZXBcbiAqIEBwYXJhbSByZXNwb25zZXNcbiAqL1xuY29uc3QgZ2V0UmVxdWVzdCA9IChjb25maWc6IFdlYldhbGtDb25maWcsIHN0ZXA6IFdlYldhbGtTdGVwQ29uZmlnLCBwcmVwYXJlZDogV2ViV2Fsa1JlcXVlc3QsIHNpdGVDb29raWVzOiBzdHJpbmcpOiBXZWJXYWxrUmVxdWVzdCA9PiB7XG4gIGlmICghc3RlcC5yZXF1ZXN0KSB7XG4gICAgc3RlcC5yZXF1ZXN0ID0ge307XG4gIH1cblxuICBsZXQgaGVhZGVycyA9IG1lcmdlSGVhZGVycyhyZXF1ZXN0SW5pdC5oZWFkZXJzLCBjb25maWcuaGVhZGVycywgc3RlcC5yZXF1ZXN0LmhlYWRlcnMsIHByZXBhcmVkLmhlYWRlcnMpO1xuICBsZXQgY29va2llcyA9IGdldENvb2tpZUhlYWRlcihzaXRlQ29va2llcywgT2JqZWN0LmFzc2lnbih7fSwgY29uZmlnLmNvb2tpZXMsIHN0ZXAucmVxdWVzdC5jb29raWVzLCBwcmVwYXJlZC5jb29raWVzKSk7XG4gIGxldCBmb3JtRGF0YSA9IGdldEZvcm1EYXRhKE9iamVjdC5hc3NpZ24oe30sIHN0ZXAucmVxdWVzdC5mb3JtRGF0YSwgcHJlcGFyZWQuZm9ybURhdGEpKTtcblxuICBsZXQgcmVxdWVzdCA9IE9iamVjdC5hc3NpZ24oe30sIHJlcXVlc3RJbml0LCBzdGVwLnJlcXVlc3QsIHByZXBhcmVkKTtcbiAgcmVxdWVzdC5oZWFkZXJzID0gaW5qZWN0Q29va2llSGVhZGVyKGhlYWRlcnMsIGNvb2tpZXMpO1xuXG4gIGlmICghcmVxdWVzdC5ib2R5ICYmIGZvcm1EYXRhKSB7XG4gICAgcmVxdWVzdC5ib2R5ID0gZm9ybURhdGE7XG4gICAgaWYgKCFyZXF1ZXN0LmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKSB7XG4gICAgICByZXF1ZXN0LmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCdcbiAgICB9XG4gIH1cblxuICBpZiAoIXJlcXVlc3QubWV0aG9kICYmIHJlcXVlc3QuYm9keSkge1xuICAgIHJlcXVlc3QubWV0aG9kID0gJ1BPU1QnO1xuICB9XG5cbiAgZGVsZXRlIHJlcXVlc3QuY29va2llcztcbiAgZGVsZXRlIHJlcXVlc3QuZm9ybURhdGE7XG5cbiAgcmV0dXJuIHJlcXVlc3Q7XG59XG5cbmV4cG9ydCBjb25zdCB3YWxrID0gYXN5bmMgKGNvbmZpZzogV2ViV2Fsa0NvbmZpZyk6IFByb21pc2U8YW55PiA9PiB7XG4gIGlmICghY29uZmlnIHx8ICFjb25maWcuc3RlcHMpIHJldHVybjtcblxuICBsZXQgc3RlcFJlc3BvbnNlczogV2ViV2Fsa1Jlc3BvbnNlW10gPSBbXTtcbiAgbGV0IHN0ZXBSZXNwb25zZTogV2ViV2Fsa1Jlc3BvbnNlO1xuICBsZXQgY29va2llSmFyOiBDb29raWVKYXIgPSBuZXcgdG91Z2guQ29va2llSmFyKCk7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb25maWcuc3RlcHMubGVuZ3RoOyArK2kpIHtcbiAgICBjb25zdCBzdGVwID0gY29uZmlnLnN0ZXBzW2ldO1xuICAgIGNvbnN0IHByZXBhcmVkID0gYXdhaXQgcHJlcGFyZShzdGVwLCBzdGVwUmVzcG9uc2VzKTtcbiAgICBjb25zdCB1cmwgPSBwcmVwYXJlZC51cmwgfHwgc3RlcC51cmw7XG4gICAgY29uc3Qgc2l0ZUNvb2tpZXMgPSBjb29raWVKYXIuZ2V0Q29va2llU3RyaW5nU3luYyh1cmwpO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBnZXRSZXF1ZXN0KGNvbmZpZywgc3RlcCwgcHJlcGFyZWQsIHNpdGVDb29raWVzKTtcbiAgICBjb25zdCByZXNwb25zZTogRmV0Y2hSZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwgcmVxdWVzdCk7XG4gICAgY29uc3Qgc2V0Q29va2llSGVhZGVycyA9IHJlc3BvbnNlLmhlYWRlcnMucmF3KClbJ3NldC1jb29raWUnXSB8fCBbXTtcbiAgICBzdGVwUmVzcG9uc2UgPSB7XG4gICAgICBoZWFkZXJzOiB0cmFuc2Zvcm1IZWFkZXJzKHJlc3BvbnNlLmhlYWRlcnMpLFxuICAgICAgY29va2llczogZXh0cmFjdENvb2tpZXMoc2V0Q29va2llSGVhZGVycyksXG4gICAgICB0ZXh0OiBhd2FpdCByZXNwb25zZS50ZXh0KClcbiAgICB9XG4gICAgc3RlcFJlc3BvbnNlLm91dHB1dCA9IGF3YWl0IHByb2Nlc3Moc3RlcCwgc3RlcFJlc3BvbnNlKTtcbiAgICBzdGVwUmVzcG9uc2VzLnB1c2goc3RlcFJlc3BvbnNlKTtcbiAgICBzZXRDb29raWVIZWFkZXJzLmZvckVhY2gobGluZSA9PiBjb29raWVKYXIuc2V0Q29va2llU3luYyhsaW5lLCByZXNwb25zZS51cmwpKTtcbiAgfVxuICByZXR1cm4gc3RlcFJlc3BvbnNlLm91dHB1dDtcbn1cbiJdfQ==