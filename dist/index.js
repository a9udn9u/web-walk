"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const node_fetch_1 = require("node-fetch");
const tough_cookie_1 = require("tough-cookie");
const requestInit = {
    cache: 'no-store',
    // Currently node-fetch doesn't support this, it's a problem when page is redirected but cookies set by the page
    // are required. A workaround is setting redirect to 'manual' so that web-walk can catch cookies.
    credentials: 'include',
    mode: 'cors',
    redirect: 'follow',
    headers: {
        'accept': '*/*',
        'accept-encoding': 'gzip,deflate,br',
        'connection': 'close',
        'user-agent': `web-walk/${require('../package.json').version}`,
    }
};
const getCookieHeader = (siteCookies, mandatoryCookies) => {
    let override = Object.keys(mandatoryCookies)
        .map(key => new tough_cookie_1.Cookie({ key, value: mandatoryCookies[key] }).cookieString())
        .join(';');
    return [siteCookies, override].filter(v => !!v).join(';');
};
const getFormData = (formDataPairs) => {
    const keys = Object.keys(formDataPairs);
    if (!keys.length)
        return;
    return keys
        .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(formDataPairs[key]))
        .join('&');
};
const injectCookieHeader = (headers, cookieHeader) => {
    let mergedCookieHeader = [headers['cookie'], cookieHeader]
        .filter(v => !!v)
        .map(v => v.trim())
        .join(';');
    if (!!mergedCookieHeader) {
        headers = Object.assign({}, headers, { 'cookie': mergedCookieHeader });
    }
    return headers;
};
const transformHeaders = (headers) => {
    let pairs = {};
    headers.forEach((value, key) => {
        let lower = key.toLowerCase();
        if ('set-cookie' !== lower) {
            pairs[lower] = value;
        }
    });
    return pairs;
};
const extractCookies = (setCookies) => {
    let pairs = {};
    let raw = [];
    if (setCookies && setCookies.length) {
        setCookies.forEach(line => {
            let parsed = tough_cookie_1.Cookie.parse(line);
            Object.assign(pairs, { [parsed.key]: parsed.value });
            raw.push({
                key: parsed.key,
                value: parsed.value,
                expires: parsed.expires,
                maxAge: parsed.maxAge,
                domain: parsed.domain,
                path: parsed.path,
                secure: parsed.secure,
                httpOnly: parsed.httpOnly
            });
        });
    }
    return {
        cookies: pairs,
        rawCookies: raw
    };
};
const mergeHeaders = (...headersArgs) => {
    let flattened = Object.assign.apply(Object, [{}].concat(headersArgs));
    let merged = {};
    Object.keys(flattened).forEach(key => merged[key.toLowerCase()] = flattened[key]);
    return merged;
};
const prepare = (step, stepResponses) => __awaiter(this, void 0, void 0, function* () {
    const lastStepResponse = stepResponses.length ? stepResponses[stepResponses.length - 1] : undefined;
    return step.prepare ? step.prepare(lastStepResponse, stepResponses) : {};
});
const process = (step, stepResponse) => __awaiter(this, void 0, void 0, function* () {
    return step.process ? step.process(stepResponse) : stepResponse.text;
});
/**
 * Generate request
 * @param config
 * @param step
 * @param responses
 */
const getRequest = (config, step, prepared, siteCookies) => {
    if (!step.request) {
        step.request = {};
    }
    let headers = mergeHeaders(requestInit.headers, config.headers, step.request.headers, prepared.headers);
    let cookies = getCookieHeader(siteCookies, Object.assign({}, config.cookies, step.request.cookies, prepared.cookies));
    let formData = getFormData(Object.assign({}, step.request.formData, prepared.formData));
    let request = Object.assign({}, requestInit, step.request, prepared);
    request.headers = injectCookieHeader(headers, cookies);
    if (!request.body && formData) {
        request.body = formData;
        if (!request.headers['content-type']) {
            request.headers['content-type'] = 'application/x-www-form-urlencoded';
        }
    }
    if (!request.method && request.body) {
        request.method = 'POST';
    }
    delete request.cookies;
    delete request.formData;
    return request;
};
exports.walk = (config) => __awaiter(this, void 0, void 0, function* () {
    if (!config || !config.steps)
        return;
    let stepResponses = [];
    let stepResponse;
    let cookieJar = new tough_cookie_1.CookieJar();
    for (let i = 0; i < config.steps.length; ++i) {
        const step = config.steps[i];
        const prepared = yield prepare(step, stepResponses);
        const url = prepared.url || step.url;
        const siteCookies = cookieJar.getCookieStringSync(url);
        const request = getRequest(config, step, prepared, siteCookies);
        const response = yield node_fetch_1.default(url, request);
        const setCookieHeaders = response.headers.raw()['set-cookie'] || [];
        stepResponse = Object.assign({ headers: transformHeaders(response.headers) }, extractCookies(setCookieHeaders), { text: yield response.text() });
        stepResponse.output = yield process(step, stepResponse);
        stepResponses.push(stepResponse);
        setCookieHeaders.forEach(line => cookieJar.setCookieSync(line, response.url));
    }
    return stepResponse.output;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLDJDQUErQjtBQUMvQiwrQ0FBaUQ7QUFFakQsTUFBTSxXQUFXLEdBQWdCO0lBQy9CLEtBQUssRUFBRSxVQUFVO0lBQ2pCLGdIQUFnSDtJQUNoSCxpR0FBaUc7SUFDakcsV0FBVyxFQUFFLFNBQVM7SUFDdEIsSUFBSSxFQUFFLE1BQU07SUFDWixRQUFRLEVBQUUsUUFBUTtJQUNsQixPQUFPLEVBQUU7UUFDUCxRQUFRLEVBQUUsS0FBSztRQUNmLGlCQUFpQixFQUFFLGlCQUFpQjtRQUNwQyxZQUFZLEVBQUUsT0FBTztRQUNyQixZQUFZLEVBQUUsWUFBWSxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxPQUFPLEVBQUU7S0FDL0Q7Q0FDRixDQUFBO0FBRUQsTUFBTSxlQUFlLEdBQUcsQ0FBQyxXQUFtQixFQUFFLGdCQUE2QixFQUFVLEVBQUU7SUFDckYsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztTQUN2QyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLHFCQUFNLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztTQUM1RSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDZixNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM1RCxDQUFDLENBQUE7QUFFRCxNQUFNLFdBQVcsR0FBRyxDQUFDLGFBQTBCLEVBQVUsRUFBRTtJQUN6RCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMs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RyxVQUFVLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDaEUsTUFBTSxRQUFRLEdBQWtCLE1BQU0sb0JBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDMUQsTUFBTSxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwRSxZQUFZLG1CQUNWLE9BQU8sRUFBRSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQ3hDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUNuQyxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLEdBQzVCLENBQUE7UUFDRCxZQUFZLENBQUMsTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUN4RCxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2pDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ2hGLENBQUM7SUFDRCxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQztBQUM3QixDQUFDLENBQUEsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCB7IENvb2tpZUphciwgQ29va2llIH0gZnJvbSAndG91Z2gtY29va2llJztcblxuY29uc3QgcmVxdWVzdEluaXQ6IFJlcXVlc3RJbml0ID0ge1xuICBjYWNoZTogJ25vLXN0b3JlJyxcbiAgLy8gQ3VycmVudGx5IG5vZGUtZmV0Y2ggZG9lc24ndCBzdXBwb3J0IHRoaXMsIGl0J3MgYSBwcm9ibGVtIHdoZW4gcGFnZSBpcyByZWRpcmVjdGVkIGJ1dCBjb29raWVzIHNldCBieSB0aGUgcGFnZVxuICAvLyBhcmUgcmVxdWlyZWQuIEEgd29ya2Fyb3VuZCBpcyBzZXR0aW5nIHJlZGlyZWN0IHRvICdtYW51YWwnIHNvIHRoYXQgd2ViLXdhbGsgY2FuIGNhdGNoIGNvb2tpZXMuXG4gIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsXG4gIG1vZGU6ICdjb3JzJyxcbiAgcmVkaXJlY3Q6ICdmb2xsb3cnLFxuICBoZWFkZXJzOiB7XG4gICAgJ2FjY2VwdCc6ICcqLyonLFxuICAgICdhY2NlcHQtZW5jb2RpbmcnOiAnZ3ppcCxkZWZsYXRlLGJyJyxcbiAgICAnY29ubmVjdGlvbic6ICdjbG9zZScsXG4gICAgJ3VzZXItYWdlbnQnOiBgd2ViLXdhbGsvJHtyZXF1aXJlKCcuLi9wYWNrYWdlLmpzb24nKS52ZXJzaW9ufWAsXG4gIH1cbn1cblxuY29uc3QgZ2V0Q29va2llSGVhZGVyID0gKHNpdGVDb29raWVzOiBzdHJpbmcsIG1hbmRhdG9yeUNvb2tpZXM6IFN0cmluZ1BhaXJzKTogc3RyaW5nID0+IHtcbiAgbGV0IG92ZXJyaWRlID0gT2JqZWN0LmtleXMobWFuZGF0b3J5Q29va2llcylcbiAgICAgIC5tYXAoa2V5ID0+IG5ldyBDb29raWUoeyBrZXksIHZhbHVlOiBtYW5kYXRvcnlDb29raWVzW2tleV0gfSkuY29va2llU3RyaW5nKCkpXG4gICAgICAuam9pbignOycpO1xuICByZXR1cm4gW3NpdGVDb29raWVzLCBvdmVycmlkZV0uZmlsdGVyKHYgPT4gISF2KS5qb2luKCc7Jyk7XG59XG5cbmNvbnN0IGdldEZvcm1EYXRhID0gKGZvcm1EYXRhUGFpcnM6IFN0cmluZ1BhaXJzKTogc3RyaW5nID0+IHtcbiAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGZvcm1EYXRhUGFpcnMpO1xuICBpZiAoIWtleXMubGVuZ3RoKSByZXR1cm47XG4gIHJldHVybiBrZXlzXG4gICAgICAubWFwKGtleSA9PiBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudChmb3JtRGF0YVBhaXJzW2tleV0pKVxuICAgICAgLmpvaW4oJyYnKTtcbn1cblxuY29uc3QgaW5qZWN0Q29va2llSGVhZGVyID0gKGhlYWRlcnM6IFN0cmluZ1BhaXJzLCBjb29raWVIZWFkZXI6IHN0cmluZyk6IFN0cmluZ1BhaXJzID0+IHtcbiAgbGV0IG1lcmdlZENvb2tpZUhlYWRlciA9IFtoZWFkZXJzWydjb29raWUnXSwgY29va2llSGVhZGVyXVxuICAgICAgLmZpbHRlcih2ID0+ICEhdilcbiAgICAgIC5tYXAodiA9PiB2LnRyaW0oKSlcbiAgICAgIC5qb2luKCc7Jyk7XG4gIGlmICghIW1lcmdlZENvb2tpZUhlYWRlcikge1xuICAgIGhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCBoZWFkZXJzLCB7ICdjb29raWUnOiBtZXJnZWRDb29raWVIZWFkZXIgfSk7XG4gIH1cbiAgcmV0dXJuIGhlYWRlcnM7XG59XG5cbmNvbnN0IHRyYW5zZm9ybUhlYWRlcnMgPSAoaGVhZGVyczogSGVhZGVycyk6IFN0cmluZ1BhaXJzID0+IHtcbiAgbGV0IHBhaXJzOiBTdHJpbmdQYWlycyA9IHt9O1xuICBoZWFkZXJzLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICBsZXQgbG93ZXIgPSBrZXkudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAoJ3NldC1jb29raWUnICE9PSBsb3dlcikge1xuICAgICAgcGFpcnNbbG93ZXJdID0gdmFsdWU7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHBhaXJzO1xufVxuXG5jb25zdCBleHRyYWN0Q29va2llcyA9IChzZXRDb29raWVzOiBzdHJpbmdbXSk6IHsgY29va2llczogU3RyaW5nUGFpcnMsIHJhd0Nvb2tpZXM6IENvb2tpZVByb3BzW10gfSA9PiB7XG4gIGxldCBwYWlyczogU3RyaW5nUGFpcnMgPSB7fTtcbiAgbGV0IHJhdzogQ29va2llUHJvcHNbXSA9IFtdO1xuICBpZiAoc2V0Q29va2llcyAmJiBzZXRDb29raWVzLmxlbmd0aCkge1xuICAgIHNldENvb2tpZXMuZm9yRWFjaChsaW5lID0+IHtcbiAgICAgIGxldCBwYXJzZWQgPSBDb29raWUucGFyc2UobGluZSk7XG4gICAgICBPYmplY3QuYXNzaWduKHBhaXJzLCB7IFtwYXJzZWQua2V5XTogcGFyc2VkLnZhbHVlIH0pO1xuICAgICAgcmF3LnB1c2goe1xuICAgICAgICBrZXk6IHBhcnNlZC5rZXksXG4gICAgICAgIHZhbHVlOiBwYXJzZWQudmFsdWUsXG4gICAgICAgIGV4cGlyZXM6IHBhcnNlZC5leHBpcmVzLFxuICAgICAgICBtYXhBZ2U6IHBhcnNlZC5tYXhBZ2UsXG4gICAgICAgIGRvbWFpbjogcGFyc2VkLmRvbWFpbixcbiAgICAgICAgcGF0aDogcGFyc2VkLnBhdGgsXG4gICAgICAgIHNlY3VyZTogcGFyc2VkLnNlY3VyZSxcbiAgICAgICAgaHR0cE9ubHk6IHBhcnNlZC5odHRwT25seVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBjb29raWVzOiBwYWlycyxcbiAgICByYXdDb29raWVzOiByYXdcbiAgfTtcbn1cblxuY29uc3QgbWVyZ2VIZWFkZXJzID0gKC4uLmhlYWRlcnNBcmdzOiBhbnlbXSk6IFN0cmluZ1BhaXJzID0+IHtcbiAgbGV0IGZsYXR0ZW5lZCA9IE9iamVjdC5hc3NpZ24uYXBwbHkoT2JqZWN0LCBbe31dLmNvbmNhdChoZWFkZXJzQXJncykpO1xuICBsZXQgbWVyZ2VkOiBTdHJpbmdQYWlycyA9IHt9O1xuICBPYmplY3Qua2V5cyhmbGF0dGVuZWQpLmZvckVhY2goa2V5ID0+IG1lcmdlZFtrZXkudG9Mb3dlckNhc2UoKV0gPSBmbGF0dGVuZWRba2V5XSk7XG4gIHJldHVybiBtZXJnZWQ7XG59XG5cbmNvbnN0IHByZXBhcmUgPSBhc3luYyAoc3RlcDogV2ViV2Fsa1N0ZXBDb25maWcsIHN0ZXBSZXNwb25zZXM6IFdlYldhbGtSZXNwb25zZVtdKTogUHJvbWlzZTxXZWJXYWxrUmVxdWVzdD4gPT4ge1xuICBjb25zdCBsYXN0U3RlcFJlc3BvbnNlID0gc3RlcFJlc3BvbnNlcy5sZW5ndGggPyBzdGVwUmVzcG9uc2VzW3N0ZXBSZXNwb25zZXMubGVuZ3RoIC0gMV0gOiB1bmRlZmluZWQ7XG4gIHJldHVybiBzdGVwLnByZXBhcmUgPyBzdGVwLnByZXBhcmUobGFzdFN0ZXBSZXNwb25zZSwgc3RlcFJlc3BvbnNlcykgOiB7fTtcbn1cblxuY29uc3QgcHJvY2VzcyA9IGFzeW5jIChzdGVwOiBXZWJXYWxrU3RlcENvbmZpZywgc3RlcFJlc3BvbnNlOiBXZWJXYWxrUmVzcG9uc2UpOiBQcm9taXNlPGFueT4gPT4ge1xuICByZXR1cm4gc3RlcC5wcm9jZXNzID8gc3RlcC5wcm9jZXNzKHN0ZXBSZXNwb25zZSkgOiBzdGVwUmVzcG9uc2UudGV4dDtcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSByZXF1ZXN0XG4gKiBAcGFyYW0gY29uZmlnXG4gKiBAcGFyYW0gc3RlcFxuICogQHBhcmFtIHJlc3BvbnNlc1xuICovXG5jb25zdCBnZXRSZXF1ZXN0ID0gKGNvbmZpZzogV2ViV2Fsa0NvbmZpZywgc3RlcDogV2ViV2Fsa1N0ZXBDb25maWcsIHByZXBhcmVkOiBXZWJXYWxrUmVxdWVzdCwgc2l0ZUNvb2tpZXM6IHN0cmluZyk6IFdlYldhbGtSZXF1ZXN0ID0+IHtcbiAgaWYgKCFzdGVwLnJlcXVlc3QpIHtcbiAgICBzdGVwLnJlcXVlc3QgPSB7fTtcbiAgfVxuXG4gIGxldCBoZWFkZXJzID0gbWVyZ2VIZWFkZXJzKHJlcXVlc3RJbml0LmhlYWRlcnMsIGNvbmZpZy5oZWFkZXJzLCBzdGVwLnJlcXVlc3QuaGVhZGVycywgcHJlcGFyZWQuaGVhZGVycyk7XG4gIGxldCBjb29raWVzID0gZ2V0Q29va2llSGVhZGVyKHNpdGVDb29raWVzLCBPYmplY3QuYXNzaWduKHt9LCBjb25maWcuY29va2llcywgc3RlcC5yZXF1ZXN0LmNvb2tpZXMsIHByZXBhcmVkLmNvb2tpZXMpKTtcbiAgbGV0IGZvcm1EYXRhID0gZ2V0Rm9ybURhdGEoT2JqZWN0LmFzc2lnbih7fSwgc3RlcC5yZXF1ZXN0LmZvcm1EYXRhLCBwcmVwYXJlZC5mb3JtRGF0YSkpO1xuXG4gIGxldCByZXF1ZXN0ID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxdWVzdEluaXQsIHN0ZXAucmVxdWVzdCwgcHJlcGFyZWQpO1xuICByZXF1ZXN0LmhlYWRlcnMgPSBpbmplY3RDb29raWVIZWFkZXIoaGVhZGVycywgY29va2llcyk7XG5cbiAgaWYgKCFyZXF1ZXN0LmJvZHkgJiYgZm9ybURhdGEpIHtcbiAgICByZXF1ZXN0LmJvZHkgPSBmb3JtRGF0YTtcbiAgICBpZiAoIXJlcXVlc3QuaGVhZGVyc1snY29udGVudC10eXBlJ10pIHtcbiAgICAgIHJlcXVlc3QuaGVhZGVyc1snY29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJ1xuICAgIH1cbiAgfVxuXG4gIGlmICghcmVxdWVzdC5tZXRob2QgJiYgcmVxdWVzdC5ib2R5KSB7XG4gICAgcmVxdWVzdC5tZXRob2QgPSAnUE9TVCc7XG4gIH1cblxuICBkZWxldGUgcmVxdWVzdC5jb29raWVzO1xuICBkZWxldGUgcmVxdWVzdC5mb3JtRGF0YTtcblxuICByZXR1cm4gcmVxdWVzdDtcbn1cblxuZXhwb3J0IGNvbnN0IHdhbGsgPSBhc3luYyAoY29uZmlnOiBXZWJXYWxrQ29uZmlnKTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgaWYgKCFjb25maWcgfHwgIWNvbmZpZy5zdGVwcykgcmV0dXJuO1xuXG4gIGxldCBzdGVwUmVzcG9uc2VzOiBXZWJXYWxrUmVzcG9uc2VbXSA9IFtdO1xuICBsZXQgc3RlcFJlc3BvbnNlOiBXZWJXYWxrUmVzcG9uc2U7XG4gIGxldCBjb29raWVKYXI6IENvb2tpZUphciA9IG5ldyBDb29raWVKYXIoKTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbmZpZy5zdGVwcy5sZW5ndGg7ICsraSkge1xuICAgIGNvbnN0IHN0ZXAgPSBjb25maWcuc3RlcHNbaV07XG4gICAgY29uc3QgcHJlcGFyZWQgPSBhd2FpdCBwcmVwYXJlKHN0ZXAsIHN0ZXBSZXNwb25zZXMpO1xuICAgIGNvbnN0IHVybCA9IHByZXBhcmVkLnVybCB8fCBzdGVwLnVybDtcbiAgICBjb25zdCBzaXRlQ29va2llcyA9IGNvb2tpZUphci5nZXRDb29raWVTdHJpbmdTeW5jKHVybCk7XG4gICAgY29uc3QgcmVxdWVzdCA9IGdldFJlcXVlc3QoY29uZmlnLCBzdGVwLCBwcmVwYXJlZCwgc2l0ZUNvb2tpZXMpO1xuICAgIGNvbnN0IHJlc3BvbnNlOiBGZXRjaFJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCByZXF1ZXN0KTtcbiAgICBjb25zdCBzZXRDb29raWVIZWFkZXJzID0gcmVzcG9uc2UuaGVhZGVycy5yYXcoKVsnc2V0LWNvb2tpZSddIHx8IFtdO1xuICAgIHN0ZXBSZXNwb25zZSA9IHtcbiAgICAgIGhlYWRlcnM6IHRyYW5zZm9ybUhlYWRlcnMocmVzcG9uc2UuaGVhZGVycyksXG4gICAgICAuLi5leHRyYWN0Q29va2llcyhzZXRDb29raWVIZWFkZXJzKSxcbiAgICAgIHRleHQ6IGF3YWl0IHJlc3BvbnNlLnRleHQoKVxuICAgIH1cbiAgICBzdGVwUmVzcG9uc2Uub3V0cHV0ID0gYXdhaXQgcHJvY2VzcyhzdGVwLCBzdGVwUmVzcG9uc2UpO1xuICAgIHN0ZXBSZXNwb25zZXMucHVzaChzdGVwUmVzcG9uc2UpO1xuICAgIHNldENvb2tpZUhlYWRlcnMuZm9yRWFjaChsaW5lID0+IGNvb2tpZUphci5zZXRDb29raWVTeW5jKGxpbmUsIHJlc3BvbnNlLnVybCkpO1xuICB9XG4gIHJldHVybiBzdGVwUmVzcG9uc2Uub3V0cHV0O1xufVxuIl19