"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const node_fetch_1 = require("node-fetch");
const tough_cookie_1 = require("tough-cookie");
const requestInit = {
    cache: 'no-store',
    // Currently node-fetch doesn't support this, it's a problem when page is redirected but cookies set by the page
    // are required. A workaround is setting redirect to 'manual' so that web-walk can catch cookies.
    credentials: 'include',
    mode: 'cors',
    redirect: 'follow',
    headers: {
        'accept': '*/*',
        'accept-encoding': 'gzip,deflate,br',
        'connection': 'close',
        'user-agent': `web-walk/${require('../package.json').version}`,
    }
};
const getCookieHeader = (siteCookies, mandatoryCookies) => {
    let override = Object.keys(mandatoryCookies)
        .map(key => new tough_cookie_1.Cookie({ key, value: mandatoryCookies[key] }).cookieString())
        .join(';');
    return [siteCookies, override].filter(v => !!v).join(';');
};
const getFormData = (formDataPairs) => {
    const keys = Object.keys(formDataPairs);
    if (!keys.length)
        return;
    return keys
        .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(formDataPairs[key]))
        .join('&');
};
const injectCookieHeader = (headers, cookieHeader) => {
    let mergedCookieHeader = [headers['cookie'], cookieHeader]
        .filter(v => !!v)
        .map(v => v.trim())
        .join(';');
    if (!!mergedCookieHeader) {
        headers = Object.assign({}, headers, { 'cookie': mergedCookieHeader });
    }
    return headers;
};
const transformHeaders = (headers) => {
    let pairs = {};
    headers.forEach((value, key) => {
        let lower = key.toLowerCase();
        if ('set-cookie' !== lower) {
            pairs[lower] = value;
        }
    });
    return pairs;
};
const extractCookies = (setCookies) => {
    let pairs = {};
    let raw = [];
    if (setCookies && setCookies.length) {
        setCookies.forEach(line => {
            let parsed = tough_cookie_1.Cookie.parse(line);
            Object.assign(pairs, { [parsed.key]: parsed.value });
            raw.push({
                key: parsed.key,
                value: parsed.value,
                expires: parsed.expires,
                maxAge: parsed.maxAge,
                domain: parsed.domain,
                path: parsed.path,
                secure: parsed.secure,
                httpOnly: parsed.httpOnly
            });
        });
    }
    return {
        cookies: pairs,
        rawCookies: raw
    };
};
const mergeHeaders = (...headersArgs) => {
    let flattened = Object.assign.apply(Object, [{}].concat(headersArgs));
    let merged = {};
    Object.keys(flattened).forEach(key => merged[key.toLowerCase()] = flattened[key]);
    return merged;
};
const prepare = (step, stepResponses) => __awaiter(this, void 0, void 0, function* () {
    const lastStepResponse = stepResponses.length ? stepResponses[stepResponses.length - 1] : undefined;
    return step.prepare ? step.prepare(lastStepResponse, stepResponses) : {};
});
const process = (step, stepResponse, stepResponses) => __awaiter(this, void 0, void 0, function* () {
    return step.process ? step.process(stepResponse, stepResponses) : stepResponse.text;
});
/**
 * Generate request
 * @param config
 * @param step
 * @param responses
 */
const getRequest = (config, step, prepared, siteCookies) => {
    if (!step.request) {
        step.request = {};
    }
    let headers = mergeHeaders(requestInit.headers, config.headers, step.request.headers, prepared.headers);
    let cookies = getCookieHeader(siteCookies, Object.assign({}, config.cookies, step.request.cookies, prepared.cookies));
    let formData = getFormData(Object.assign({}, step.request.formData, prepared.formData));
    let request = Object.assign({}, requestInit, step.request, prepared);
    request.headers = injectCookieHeader(headers, cookies);
    if (!request.body && formData) {
        request.body = formData;
        if (!request.headers['content-type']) {
            request.headers['content-type'] = 'application/x-www-form-urlencoded';
        }
    }
    if (!request.method && request.body) {
        request.method = 'POST';
    }
    delete request.cookies;
    delete request.formData;
    return request;
};
exports.walk = (config) => __awaiter(this, void 0, void 0, function* () {
    if (!config || !config.steps)
        return;
    let stepResponses = [];
    let stepResponse;
    let cookieJar = new tough_cookie_1.CookieJar();
    for (let i = 0; i < config.steps.length; ++i) {
        const step = config.steps[i];
        const prepared = yield prepare(step, stepResponses);
        const url = prepared.url || step.url;
        const siteCookies = cookieJar.getCookieStringSync(url);
        const request = getRequest(config, step, prepared, siteCookies);
        const response = yield node_fetch_1.default(url, request);
        const setCookieHeaders = response.headers.raw()['set-cookie'] || [];
        stepResponse = Object.assign({ status: response.status, headers: transformHeaders(response.headers) }, extractCookies(setCookieHeaders), { text: yield response.text() });
        stepResponse.output = yield process(step, stepResponse, stepResponses);
        stepResponses.push(stepResponse);
        setCookieHeaders.forEach(line => {
            try {
                cookieJar.setCookieSync(line, response.url);
            }
            catch (ex) {
                // Ignore cookie with incorrect domain
            }
        });
    }
    return stepResponse.output;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLDJDQUErQjtBQUMvQiwrQ0FBaUQ7QUFFakQsTUFBTSxXQUFXLEdBQWdCO0lBQy9CLEtBQUssRUFBRSxVQUFVO0lBQ2pCLGdIQUFnSDtJQUNoSCxpR0FBaUc7SUFDakcsV0FBVyxFQUFFLFNBQVM7SUFDdEIsSUFBSSxFQUFFLE1BQU07SUFDWixRQUFRLEVBQUUsUUFBUTtJQUNsQixPQUFPLEVBQUU7UUFDUCxRQUFRLEVBQUUsS0FBSztRQUNmLGlCQUFpQixFQUFFLGlCQUFpQjtRQUNwQyxZQUFZLEVBQUUsT0FBTztRQUNyQixZQUFZLEVBQUUsWUFBWSxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxPQUFPLEVBQUU7S0FDL0Q7Q0FDRixDQUFBO0FBRUQsTUFBTSxlQUFlLEdBQUcsQ0FBQyxXQUFtQixFQUFFLGdCQUE2QixFQUFVLEVBQUU7SUFDckYsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztTQUN2QyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLHFCQUFNLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztTQUM1RSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDZixPQUFPLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDNUQsQ0FBQyxDQUFBO0FBRUQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxhQUEwQixFQUFVLEVBQUU7SUFDekQsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUks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TyxFQUFFLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFDeEMsY0FBYyxDQUFDLGdCQUFnQixDQUFDLElBQ25DLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsR0FDNUIsQ0FBQTtRQUNELFlBQVksQ0FBQyxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN2RSxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2pDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUM5QixJQUFJO2dCQUNGLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUM3QztZQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNYLHNDQUFzQzthQUN2QztRQUNILENBQUMsQ0FBQyxDQUFDO0tBQ0o7SUFDRCxPQUFPLFlBQVksQ0FBQyxNQUFNLENBQUM7QUFDN0IsQ0FBQyxDQUFBLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2ggZnJvbSAnbm9kZS1mZXRjaCc7XG5pbXBvcnQgeyBDb29raWVKYXIsIENvb2tpZSB9IGZyb20gJ3RvdWdoLWNvb2tpZSc7XG5cbmNvbnN0IHJlcXVlc3RJbml0OiBSZXF1ZXN0SW5pdCA9IHtcbiAgY2FjaGU6ICduby1zdG9yZScsXG4gIC8vIEN1cnJlbnRseSBub2RlLWZldGNoIGRvZXNuJ3Qgc3VwcG9ydCB0aGlzLCBpdCdzIGEgcHJvYmxlbSB3aGVuIHBhZ2UgaXMgcmVkaXJlY3RlZCBidXQgY29va2llcyBzZXQgYnkgdGhlIHBhZ2VcbiAgLy8gYXJlIHJlcXVpcmVkLiBBIHdvcmthcm91bmQgaXMgc2V0dGluZyByZWRpcmVjdCB0byAnbWFudWFsJyBzbyB0aGF0IHdlYi13YWxrIGNhbiBjYXRjaCBjb29raWVzLlxuICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLFxuICBtb2RlOiAnY29ycycsXG4gIHJlZGlyZWN0OiAnZm9sbG93JyxcbiAgaGVhZGVyczoge1xuICAgICdhY2NlcHQnOiAnKi8qJyxcbiAgICAnYWNjZXB0LWVuY29kaW5nJzogJ2d6aXAsZGVmbGF0ZSxicicsXG4gICAgJ2Nvbm5lY3Rpb24nOiAnY2xvc2UnLFxuICAgICd1c2VyLWFnZW50JzogYHdlYi13YWxrLyR7cmVxdWlyZSgnLi4vcGFja2FnZS5qc29uJykudmVyc2lvbn1gLFxuICB9XG59XG5cbmNvbnN0IGdldENvb2tpZUhlYWRlciA9IChzaXRlQ29va2llczogc3RyaW5nLCBtYW5kYXRvcnlDb29raWVzOiBTdHJpbmdQYWlycyk6IHN0cmluZyA9PiB7XG4gIGxldCBvdmVycmlkZSA9IE9iamVjdC5rZXlzKG1hbmRhdG9yeUNvb2tpZXMpXG4gICAgICAubWFwKGtleSA9PiBuZXcgQ29va2llKHsga2V5LCB2YWx1ZTogbWFuZGF0b3J5Q29va2llc1trZXldIH0pLmNvb2tpZVN0cmluZygpKVxuICAgICAgLmpvaW4oJzsnKTtcbiAgcmV0dXJuIFtzaXRlQ29va2llcywgb3ZlcnJpZGVdLmZpbHRlcih2ID0+ICEhdikuam9pbignOycpO1xufVxuXG5jb25zdCBnZXRGb3JtRGF0YSA9IChmb3JtRGF0YVBhaXJzOiBTdHJpbmdQYWlycyk6IHN0cmluZyA9PiB7XG4gIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhmb3JtRGF0YVBhaXJzKTtcbiAgaWYgKCFrZXlzLmxlbmd0aCkgcmV0dXJuO1xuICByZXR1cm4ga2V5c1xuICAgICAgLm1hcChrZXkgPT4gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZm9ybURhdGFQYWlyc1trZXldKSlcbiAgICAgIC5qb2luKCcmJyk7XG59XG5cbmNvbnN0IGluamVjdENvb2tpZUhlYWRlciA9IChoZWFkZXJzOiBTdHJpbmdQYWlycywgY29va2llSGVhZGVyOiBzdHJpbmcpOiBTdHJpbmdQYWlycyA9PiB7XG4gIGxldCBtZXJnZWRDb29raWVIZWFkZXIgPSBbaGVhZGVyc1snY29va2llJ10sIGNvb2tpZUhlYWRlcl1cbiAgICAgIC5maWx0ZXIodiA9PiAhIXYpXG4gICAgICAubWFwKHYgPT4gdi50cmltKCkpXG4gICAgICAuam9pbignOycpO1xuICBpZiAoISFtZXJnZWRDb29raWVIZWFkZXIpIHtcbiAgICBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgaGVhZGVycywgeyAnY29va2llJzogbWVyZ2VkQ29va2llSGVhZGVyIH0pO1xuICB9XG4gIHJldHVybiBoZWFkZXJzO1xufVxuXG5jb25zdCB0cmFuc2Zvcm1IZWFkZXJzID0gKGhlYWRlcnM6IEhlYWRlcnMpOiBTdHJpbmdQYWlycyA9PiB7XG4gIGxldCBwYWlyczogU3RyaW5nUGFpcnMgPSB7fTtcbiAgaGVhZGVycy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgbGV0IGxvd2VyID0ga2V5LnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKCdzZXQtY29va2llJyAhPT0gbG93ZXIpIHtcbiAgICAgIHBhaXJzW2xvd2VyXSA9IHZhbHVlO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBwYWlycztcbn1cblxuY29uc3QgZXh0cmFjdENvb2tpZXMgPSAoc2V0Q29va2llczogc3RyaW5nW10pOiB7IGNvb2tpZXM6IFN0cmluZ1BhaXJzLCByYXdDb29raWVzOiBDb29raWVQcm9wc1tdIH0gPT4ge1xuICBsZXQgcGFpcnM6IFN0cmluZ1BhaXJzID0ge307XG4gIGxldCByYXc6IENvb2tpZVByb3BzW10gPSBbXTtcbiAgaWYgKHNldENvb2tpZXMgJiYgc2V0Q29va2llcy5sZW5ndGgpIHtcbiAgICBzZXRDb29raWVzLmZvckVhY2gobGluZSA9PiB7XG4gICAgICBsZXQgcGFyc2VkID0gQ29va2llLnBhcnNlKGxpbmUpO1xuICAgICAgT2JqZWN0LmFzc2lnbihwYWlycywgeyBbcGFyc2VkLmtleV06IHBhcnNlZC52YWx1ZSB9KTtcbiAgICAgIHJhdy5wdXNoKHtcbiAgICAgICAga2V5OiBwYXJzZWQua2V5LFxuICAgICAgICB2YWx1ZTogcGFyc2VkLnZhbHVlLFxuICAgICAgICBleHBpcmVzOiBwYXJzZWQuZXhwaXJlcyxcbiAgICAgICAgbWF4QWdlOiBwYXJzZWQubWF4QWdlLFxuICAgICAgICBkb21haW46IHBhcnNlZC5kb21haW4sXG4gICAgICAgIHBhdGg6IHBhcnNlZC5wYXRoLFxuICAgICAgICBzZWN1cmU6IHBhcnNlZC5zZWN1cmUsXG4gICAgICAgIGh0dHBPbmx5OiBwYXJzZWQuaHR0cE9ubHlcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIHJldHVybiB7XG4gICAgY29va2llczogcGFpcnMsXG4gICAgcmF3Q29va2llczogcmF3XG4gIH07XG59XG5cbmNvbnN0IG1lcmdlSGVhZGVycyA9ICguLi5oZWFkZXJzQXJnczogYW55W10pOiBTdHJpbmdQYWlycyA9PiB7XG4gIGxldCBmbGF0dGVuZWQgPSBPYmplY3QuYXNzaWduLmFwcGx5KE9iamVjdCwgW3t9XS5jb25jYXQoaGVhZGVyc0FyZ3MpKTtcbiAgbGV0IG1lcmdlZDogU3RyaW5nUGFpcnMgPSB7fTtcbiAgT2JqZWN0LmtleXMoZmxhdHRlbmVkKS5mb3JFYWNoKGtleSA9PiBtZXJnZWRba2V5LnRvTG93ZXJDYXNlKCldID0gZmxhdHRlbmVkW2tleV0pO1xuICByZXR1cm4gbWVyZ2VkO1xufVxuXG5jb25zdCBwcmVwYXJlID0gYXN5bmMgKHN0ZXA6IFdlYldhbGtTdGVwQ29uZmlnLCBzdGVwUmVzcG9uc2VzOiBXZWJXYWxrUmVzcG9uc2VbXSk6IFByb21pc2U8V2ViV2Fsa1JlcXVlc3Q+ID0+IHtcbiAgY29uc3QgbGFzdFN0ZXBSZXNwb25zZSA9IHN0ZXBSZXNwb25zZXMubGVuZ3RoID8gc3RlcFJlc3BvbnNlc1tzdGVwUmVzcG9uc2VzLmxlbmd0aCAtIDFdIDogdW5kZWZpbmVkO1xuICByZXR1cm4gc3RlcC5wcmVwYXJlID8gc3RlcC5wcmVwYXJlKGxhc3RTdGVwUmVzcG9uc2UsIHN0ZXBSZXNwb25zZXMpIDoge307XG59XG5cbmNvbnN0IHByb2Nlc3MgPSBhc3luYyAoc3RlcDogV2ViV2Fsa1N0ZXBDb25maWcsIHN0ZXBSZXNwb25zZTogV2ViV2Fsa1Jlc3BvbnNlLCBzdGVwUmVzcG9uc2VzOiBXZWJXYWxrUmVzcG9uc2VbXSk6IFByb21pc2U8YW55PiA9PiB7XG4gIHJldHVybiBzdGVwLnByb2Nlc3MgPyBzdGVwLnByb2Nlc3Moc3RlcFJlc3BvbnNlLCBzdGVwUmVzcG9uc2VzKSA6IHN0ZXBSZXNwb25zZS50ZXh0O1xufVxuXG4vKipcbiAqIEdlbmVyYXRlIHJlcXVlc3RcbiAqIEBwYXJhbSBjb25maWdcbiAqIEBwYXJhbSBzdGVwXG4gKiBAcGFyYW0gcmVzcG9uc2VzXG4gKi9cbmNvbnN0IGdldFJlcXVlc3QgPSAoY29uZmlnOiBXZWJXYWxrQ29uZmlnLCBzdGVwOiBXZWJXYWxrU3RlcENvbmZpZywgcHJlcGFyZWQ6IFdlYldhbGtSZXF1ZXN0LCBzaXRlQ29va2llczogc3RyaW5nKTogV2ViV2Fsa1JlcXVlc3QgPT4ge1xuICBpZiAoIXN0ZXAucmVxdWVzdCkge1xuICAgIHN0ZXAucmVxdWVzdCA9IHt9O1xuICB9XG5cbiAgbGV0IGhlYWRlcnMgPSBtZXJnZUhlYWRlcnMocmVxdWVzdEluaXQuaGVhZGVycywgY29uZmlnLmhlYWRlcnMsIHN0ZXAucmVxdWVzdC5oZWFkZXJzLCBwcmVwYXJlZC5oZWFkZXJzKTtcbiAgbGV0IGNvb2tpZXMgPSBnZXRDb29raWVIZWFkZXIoc2l0ZUNvb2tpZXMsIE9iamVjdC5hc3NpZ24oe30sIGNvbmZpZy5jb29raWVzLCBzdGVwLnJlcXVlc3QuY29va2llcywgcHJlcGFyZWQuY29va2llcykpO1xuICBsZXQgZm9ybURhdGEgPSBnZXRGb3JtRGF0YShPYmplY3QuYXNzaWduKHt9LCBzdGVwLnJlcXVlc3QuZm9ybURhdGEsIHByZXBhcmVkLmZvcm1EYXRhKSk7XG5cbiAgbGV0IHJlcXVlc3QgPSBPYmplY3QuYXNzaWduKHt9LCByZXF1ZXN0SW5pdCwgc3RlcC5yZXF1ZXN0LCBwcmVwYXJlZCk7XG4gIHJlcXVlc3QuaGVhZGVycyA9IGluamVjdENvb2tpZUhlYWRlcihoZWFkZXJzLCBjb29raWVzKTtcblxuICBpZiAoIXJlcXVlc3QuYm9keSAmJiBmb3JtRGF0YSkge1xuICAgIHJlcXVlc3QuYm9keSA9IGZvcm1EYXRhO1xuICAgIGlmICghcmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSkge1xuICAgICAgcmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnXG4gICAgfVxuICB9XG5cbiAgaWYgKCFyZXF1ZXN0Lm1ldGhvZCAmJiByZXF1ZXN0LmJvZHkpIHtcbiAgICByZXF1ZXN0Lm1ldGhvZCA9ICdQT1NUJztcbiAgfVxuXG4gIGRlbGV0ZSByZXF1ZXN0LmNvb2tpZXM7XG4gIGRlbGV0ZSByZXF1ZXN0LmZvcm1EYXRhO1xuXG4gIHJldHVybiByZXF1ZXN0O1xufVxuXG5leHBvcnQgY29uc3Qgd2FsayA9IGFzeW5jIChjb25maWc6IFdlYldhbGtDb25maWcpOiBQcm9taXNlPGFueT4gPT4ge1xuICBpZiAoIWNvbmZpZyB8fCAhY29uZmlnLnN0ZXBzKSByZXR1cm47XG5cbiAgbGV0IHN0ZXBSZXNwb25zZXM6IFdlYldhbGtSZXNwb25zZVtdID0gW107XG4gIGxldCBzdGVwUmVzcG9uc2U6IFdlYldhbGtSZXNwb25zZTtcbiAgbGV0IGNvb2tpZUphcjogQ29va2llSmFyID0gbmV3IENvb2tpZUphcigpO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY29uZmlnLnN0ZXBzLmxlbmd0aDsgKytpKSB7XG4gICAgY29uc3Qgc3RlcCA9IGNvbmZpZy5zdGVwc1tpXTtcbiAgICBjb25zdCBwcmVwYXJlZCA9IGF3YWl0IHByZXBhcmUoc3RlcCwgc3RlcFJlc3BvbnNlcyk7XG4gICAgY29uc3QgdXJsID0gcHJlcGFyZWQudXJsIHx8IHN0ZXAudXJsO1xuICAgIGNvbnN0IHNpdGVDb29raWVzID0gY29va2llSmFyLmdldENvb2tpZVN0cmluZ1N5bmModXJsKTtcbiAgICBjb25zdCByZXF1ZXN0ID0gZ2V0UmVxdWVzdChjb25maWcsIHN0ZXAsIHByZXBhcmVkLCBzaXRlQ29va2llcyk7XG4gICAgY29uc3QgcmVzcG9uc2U6IEZldGNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHJlcXVlc3QpO1xuICAgIGNvbnN0IHNldENvb2tpZUhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzLnJhdygpWydzZXQtY29va2llJ10gfHwgW107XG4gICAgc3RlcFJlc3BvbnNlID0ge1xuICAgICAgc3RhdHVzOiByZXNwb25zZS5zdGF0dXMsXG4gICAgICBoZWFkZXJzOiB0cmFuc2Zvcm1IZWFkZXJzKHJlc3BvbnNlLmhlYWRlcnMpLFxuICAgICAgLi4uZXh0cmFjdENvb2tpZXMoc2V0Q29va2llSGVhZGVycyksXG4gICAgICB0ZXh0OiBhd2FpdCByZXNwb25zZS50ZXh0KClcbiAgICB9XG4gICAgc3RlcFJlc3BvbnNlLm91dHB1dCA9IGF3YWl0IHByb2Nlc3Moc3RlcCwgc3RlcFJlc3BvbnNlLCBzdGVwUmVzcG9uc2VzKTtcbiAgICBzdGVwUmVzcG9uc2VzLnB1c2goc3RlcFJlc3BvbnNlKTtcbiAgICBzZXRDb29raWVIZWFkZXJzLmZvckVhY2gobGluZSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb29raWVKYXIuc2V0Q29va2llU3luYyhsaW5lLCByZXNwb25zZS51cmwpO1xuICAgICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgICAgLy8gSWdub3JlIGNvb2tpZSB3aXRoIGluY29ycmVjdCBkb21haW5cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICByZXR1cm4gc3RlcFJlc3BvbnNlLm91dHB1dDtcbn1cbiJdfQ==